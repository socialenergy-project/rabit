<%= content_for :title, @user_clustering_scenario.name || @user_clustering_scenario.id.to_s -%>

<div class="row">
  <div class="col-lg-12">
    <div class="card mb-3">
      <div class="card-header">
        <i class="fa fa-area-chart"></i>
        user_clustering_scenario properties
      </div>
      <div class="card-body">
        <p>
          <strong>name:</strong>
          <%= @user_clustering_scenario.name-%>
        </p>
        <p>
          <strong>Kappa:</strong>
          <%= @user_clustering_scenario.kappa-%>
        </p>
        <p>
          <strong>Silhouette:</strong>
          <%= @user_clustering_scenario.silhouette-%>
        </p>

        <p>
          <strong>User parameters:</strong>
          <% if @user_params&.keys && @param_keys  %>
            <table class="table-responsive table-striped table-bordered table-hover">
              <thead>
                <tr>
                    <th>User</th>
                    <% @param_keys.each do |k| %>
                      <th><%= k.humanize %></th>
                    <% end %>
                    <th>cluster</th>
                </tr>
              </thead>
              <tbody>
                <% @user_params.keys.sort_by{|k| @user_clustering_scenario.cluster_for(k)}.each do |u|  %>
                  <tr>
                    <th><%= User.find(u)&.uid %></th>
                      <% @param_keys.each do |k| %>
                        <td><%= @user_params[u][k] %></td>
                      <% end %>
                    <td><%= @user_clustering_scenario.cluster_for(u) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>

          <% end %>
        </p>

        <%= link_to 'Edit', edit_user_clustering_scenario_path(@user_clustering_scenario), class: 'btn btn-warning btn-sm' if can? :edit, @user_clustering_scenario %> |
        <%= link_to 'All User Clustering Scenarios', user_clustering_scenarios_path, class: 'btn btn-info btn-sm' %>

      </div>
      <div class="card-footer small text-muted">
      </div>
    </div>
  </div>

  <div class="col-lg-12 d-flex">
    <div class="card mb-3 card-100">
      <div class="card-header">
        <i class="fa fa-money"></i>
        Recommendations
      </div>
      <div class="card-body">


        <% @user_clustering_scenario.get_clusters.each do |cluster, members| %>
          <hr>
          <div>
            Cluster <%= cluster %>, members: <%= User.where(id: members).pluck(:name).join(", ") %>

            <%= render partial: 'recommendations/partial_index', locals: {
              recommendations: @user_clustering_scenario.recommendations.joins(:recommendations_users).where('recommendations_users.user_id': members).distinct
            } %>

            <%= link_to 'Create Recommendation', new_recommendation_path({recommendation: {
                user_ids: members,
                recommendable_id: @user_clustering_scenario.id,
                recommendable_type: @user_clustering_scenario.class,
                parameter: "",
                recommendation_type_id: RecommendationType.find_by(name: "Switch Energy Program")&.id,
            } }), class: 'btn btn-danger btn-sm' if can? :create, :recommendation %>
          </div>
        <% end %>
      </div>
      <div class="card-footer small text-muted">
      </div>
    </div>
  </div>


  <% @results&.each do |r| %>
  <div class="col-lg-6 align-items-stretch">
    <div class="card mb-3">
      <div class="card-header">
        <i class="fa fa-area-chart"></i>
        <%= r[:x_label] %>, <%= r[:y_label] %>
      </div>
      <div class="card-body">
        <canvas id="ucr_<%= r[:x_label] %>_<%= r[:y_label] %>" width="100%" height="55"></canvas>
      </div>
      <div class="card-footer small text-muted">
      </div>
    </div>
  </div>
  <% end %>

</div>

<script>
    console.log("Turbolinks called");

    <% @results&.each do |r| %>
       createScatterChart("ucr_<%= r[:x_label] %>_<%= r[:y_label] %>", <%= r[:dataset].to_json.html_safe -%>, "<%= r[:x_label]-%>", "<%= r[:y_label] %>");
    <% end %>
</script>


